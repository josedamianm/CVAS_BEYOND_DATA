# Subscription Query Scripts

This folder contains two scripts for querying subscription data from the aggregated parquet file.

## Scripts

### 1. `analyze_subscriptions.py`
**Purpose:** Detailed analysis and formatted view of subscription data

**Usage:**
```bash
python Scripts/analyze_subscriptions.py <msisdn>
```

**Example:**
```bash
python Scripts/analyze_subscriptions.py 34684625552
```

**Output Includes:**
- üìã Basic Information (ID, User, Status, Lifetime)
- üì± CPC Information (List, Count, Upgrades)
- üöÄ Activation Details (Date, Campaign, Channel, Revenue)
- üîÑ Renewal Information (Count, Revenue, Dates)
- ‚ùå Termination Details (Deactivation, Cancellation)
- üí∞ Financial Summary (Revenue breakdown, Refunds)
- üìä Summary Statistics

**Best For:**
- Human-readable formatted output
- Quick customer service lookups
- Understanding subscription lifecycle
- Identifying issues (missing activations, refunds)

---

### 2. `query_subscription_raw.py`
**Purpose:** Complete raw data output with comprehensive analysis

**Usage:**
```bash
python Scripts/query_subscription_raw.py <msisdn>
```

**Example:**
```bash
python Scripts/query_subscription_raw.py 34684625552
```

**Output Includes:**

#### SECTION 1: Complete Raw Data Output
- All columns and values as stored in parquet file
- Unformatted SELECT * output

#### SECTION 2: Detailed Column-by-Column Breakdown
- Organized by category (Identifiers, CPC, Activation, etc.)
- All fields with NULL values shown explicitly

#### SECTION 3: Summarized Output
- üìä Overall Statistics (totals, averages, counts ‚Äî Polars DataFrame)
- üì± CPC Breakdown (by CPC code ‚Äî Polars DataFrame)
- üìà Status Breakdown (Active/Deactivated/Cancelled ‚Äî Polars DataFrame)
- üìÖ Subscription Timeline (chronological view ‚Äî Polars DataFrame)
- üîç Key Insights (automated analysis ‚Äî summary as Polars output)

**Best For:**
- Data analysis and debugging
- Complete data export
- Understanding all available fields
- Technical investigations
- Comparing multiple subscriptions

---

## Data Source

Both scripts query from:
```
Parquet_Data/aggregated/subscriptions.parquet
```

This file is generated by `Scripts/05_build_subscription_view.py` and contains:
- **1,087,685 subscriptions**
- **773,271 unique users**
- **37 columns** of subscription data
- **102 MB** (Snappy compressed)

---

## Requirements

- Python 3.x
- DuckDB (`conda install duckdb`)
- Pandas

---

## Column Reference

### Core Fields
- `subscription_id` - Unique subscription identifier
- `tmuserid` - User identifier
- `msisdn` - Phone number
- `subscription_status` - Active/Deactivated/Cancelled

### CPC Information
- `cpc_list` - List of all CPCs
- `first_cpc` - Initial CPC
- `current_cpc` - Current CPC
- `has_upgraded` - Upgrade flag

### Financial
- `activation_revenue` - Revenue from activation
- `renewal_revenue` - Revenue from renewals
- `total_revenue` - Total revenue
- `total_refunded` - Refunded amount

### Dates
- `activation_date` - When subscription started

## Requirements

- Python 3.x
- DuckDB (`conda install duckdb`)
- Polars (`conda install polars`)

**Note:** Both scripts use **Polars** for data manipulation, consistent with other scripts in this project (01_convert_historical.py, 02_process_daily.py, 03_validate_data.py, etc.).
- `last_activity_date` - Most recent activity
- `end_date` - When subscription ended (if applicable)

### Flags
- `missing_act_record` - Missing activation transaction
- `has_upgraded` - CPC upgrade occurred

---

## Examples

### Example 1: Active Customer
```bash
python Scripts/analyze_subscriptions.py 34684625552
```
Output shows:
- Active subscription since 2023-09-13
- 98 renewals
- $242.06 total revenue
- No upgrades or refunds

### Example 2: Raw Data Export
```bash
python Scripts/query_subscription_raw.py 34684625552 > customer_report.txt
```
Exports complete raw data to file for analysis.

---

## Notes

1. **Missing Activation Records**: ~38% of subscriptions have `missing_act_record = TRUE`. This is normal and handled by the ETL process (subscriptions identified through RENO transactions).

2. **Date Format**: Dates are stored as timestamps and displayed in `YYYY-MM-DD HH:MM:SS` format.

3. **NULL Values**: NULL values indicate the field is not applicable (e.g., no cancellation date for active subscriptions).

4. **Performance**: Queries are fast due to parquet columnar format and DuckDB optimization.

---

## Troubleshooting

**Error: "No module named 'duckdb'"**
```bash
conda install duckdb
```

**Error: "No subscriptions found"**
- Verify the MSISDN exists in the database
- Check for leading/trailing spaces
- Ensure parquet file path is correct

**Error: "File not found"**
- Run from project root directory
- Verify `Parquet_Data/aggregated/subscriptions.parquet` exists
